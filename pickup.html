<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="js/kiosk.js"></script>
<script type="text/javascript" src="js/main.js"> </script>
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<link rel="stylesheet" href="css/pickup.css" type="text/css">
<link rel="shortcut icon" href="#">

<title>Pick up</title>

<script type="text/javascript">

    let sKiosk = initKopaKiosk();
    let sLocker = initLocker();

    let sReturnDate = "";

    function doorClosed()
    {
        let tCurrentList = StackedList.getItemList();
        let tActiveItem = tCurrentList.getActiveItem();

        if (tActiveItem === null || !("itemId" in tActiveItem))
        {
            debugger;
            console.log(tActiveItem);

            return;
        }

        sKiosk.commitCart()
            .then(() => {
                console.log("about to pick up next item");
                pickUpNextItem();
            });
    }

    function pickUpNextItem()
    {
        let tCurrentList = StackedList.getItemList();
        let tActiveItem = tCurrentList.pickUpNextItem();

        // All items returned, switch to next page
        if (tActiveItem === null)
        {
            UIGoToPage("thankyou", {returnDate: sReturnDate});
        }
        else
        {
            sLocker.openItemDoor(tActiveItem.itemId)
                .then(() => {
                    sReturnDate = Translator.getDate(Kiosk.getReturnDate(tActiveItem));

                    return sKiosk.borrowItem(tActiveItem.itemId);
                })
                .then(() => {
                    console.log("Watching door!!!");
                    sLocker.watchItemDoorStatus(tActiveItem.itemId, doorClosed);
                })
                .catch(pError => {
                    debugger;
                    //UIGoToPage("oops");
                });
        }
    }


    addLoadEvent(function() {
        let tList = StackedList.createLockerList("itemList", "selected", true);

        sKiosk.clearCart()
                .then(() => {
            sLocker.loadMap()
                    .then(pMap => {
                        tList.setLockerMap(pMap);
                        pickUpNextItem();
                    })
                });
    });

</script>
</head>

<body>
<div class="small header">
    <div class="language">EN</div>
    <div class="logout" id="header-logout">Log out</div>
</div>
<div class="content">
    <div class="title">Borrow - Hit C to mimic door closing</div>
    <div id="selected"></div>
    <div id="itemList"></div>
</div>

<div class="footer gray">
    <a href="borrow.html" class="left-link">Need help?</a>
</div>

</body>

</html> 